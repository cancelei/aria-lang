# ARIA-M17-01: Cargo Design Deep Study

**Task ID**: ARIA-M17-01
**Status**: Completed
**Date**: 2026-01-14
**Focus**: Study Cargo's package manager architecture deeply

---

## Executive Summary

Cargo is consistently rated among the best package managers. This research analyzes its manifest format, build system integration, and ecosystem tooling to inform Aria's package management design.

---

## 1. Overview

### 1.1 What Makes Cargo Special

- **Unified tool**: Build, test, doc, publish, dependencies
- **Reproducible builds**: Lock files by default
- **Workspace support**: Monorepo-friendly
- **Extension ecosystem**: cargo-* tools
- **Integrated documentation**: `cargo doc`

### 1.2 Components

```
Cargo Ecosystem
├── cargo (CLI tool)
├── crates.io (package registry)
├── Cargo.toml (manifest format)
├── Cargo.lock (lock file)
├── rustdoc (documentation)
└── cargo-* (extensions)
```

---

## 2. Manifest Format (Cargo.toml)

### 2.1 Basic Structure

```toml
[package]
name = "my-project"
version = "0.1.0"
edition = "2021"
authors = ["Dev <dev@example.com>"]
description = "A cool project"
license = "MIT OR Apache-2.0"
repository = "https://github.com/user/repo"

[dependencies]
serde = "1.0"
tokio = { version = "1.0", features = ["full"] }

[dev-dependencies]
criterion = "0.5"

[build-dependencies]
cc = "1.0"

[features]
default = ["std"]
std = []
async = ["tokio"]

[[bin]]
name = "my-tool"
path = "src/bin/tool.rs"

[profile.release]
opt-level = 3
lto = true
```

### 2.2 Dependency Specification

```toml
# Version requirements
serde = "1.0"              # ^1.0.0 (>=1.0.0, <2.0.0)
serde = "=1.0.104"         # Exact version
serde = ">=1.0, <1.5"      # Range
serde = "*"                # Any version (avoid!)

# Source specifications
# From crates.io (default)
serde = "1.0"

# From Git
my-lib = { git = "https://github.com/user/lib" }
my-lib = { git = "...", branch = "main" }
my-lib = { git = "...", tag = "v1.0" }
my-lib = { git = "...", rev = "abc123" }

# From path (local development)
my-lib = { path = "../my-lib" }

# With features
tokio = { version = "1.0", features = ["rt-multi-thread", "macros"] }
tokio = { version = "1.0", default-features = false }
```

### 2.3 Features System

```toml
[features]
default = ["std", "derive"]

# Feature flags
std = []                    # Empty = just a flag
derive = ["serde_derive"]   # Enables dependency
async = ["tokio", "async-trait"]  # Multiple deps

# Optional dependencies become features
serde = { version = "1.0", optional = true }

# Dependency features
tokio = { version = "1.0", features = ["full"] }
```

---

## 3. Build System

### 3.1 Build Process

```
cargo build
    ↓
1. Parse Cargo.toml
2. Resolve dependencies (PubGrub)
3. Download missing crates
4. Generate Cargo.lock
5. Compile dependency graph (parallel)
6. Link final binary
```

### 3.2 Build Scripts

```rust
// build.rs (runs before compilation)
fn main() {
    // Set environment variables
    println!("cargo:rustc-env=GIT_HASH={}", get_git_hash());

    // Link native libraries
    println!("cargo:rustc-link-lib=sqlite3");

    // Rerun conditions
    println!("cargo:rerun-if-changed=build.rs");
    println!("cargo:rerun-if-env-changed=MY_VAR");

    // Generate code
    generate_bindings();
}
```

### 3.3 Profiles

```toml
[profile.dev]
opt-level = 0
debug = true
overflow-checks = true

[profile.release]
opt-level = 3
debug = false
lto = true
codegen-units = 1
panic = "abort"

[profile.bench]
inherits = "release"
debug = true

# Custom profile
[profile.release-with-debug]
inherits = "release"
debug = true
```

---

## 4. Workspaces

### 4.1 Workspace Configuration

```toml
# Root Cargo.toml
[workspace]
members = [
    "core",
    "cli",
    "plugins/*"
]
exclude = ["experiments"]

# Shared settings
[workspace.package]
version = "1.0.0"
authors = ["Team"]
edition = "2021"

[workspace.dependencies]
serde = "1.0"
tokio = { version = "1.0", features = ["full"] }
```

### 4.2 Member Inheritance

```toml
# Member Cargo.toml
[package]
name = "my-cli"
version.workspace = true
authors.workspace = true
edition.workspace = true

[dependencies]
serde.workspace = true
my-core = { path = "../core" }
```

---

## 5. Lock Files

### 5.1 Cargo.lock Structure

```toml
# This file is automatically @generated by Cargo.
[[package]]
name = "serde"
version = "1.0.193"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "..."
dependencies = [
    "serde_derive",
]

[[package]]
name = "my-project"
version = "0.1.0"
dependencies = [
    "serde",
    "tokio",
]
```

### 5.2 Lock File Behavior

| Command | Lock File |
|---------|-----------|
| `cargo build` | Creates if missing, uses if present |
| `cargo update` | Updates all to latest compatible |
| `cargo update -p serde` | Updates specific package |

---

## 6. Registry (crates.io)

### 6.1 Package Publication

```bash
# Login
cargo login <token>

# Check before publish
cargo publish --dry-run

# Publish
cargo publish

# Yank (soft delete)
cargo yank --version 1.0.1
```

### 6.2 Registry Index

```
crates.io-index/
├── config.json
├── 1/           # Single-char names
├── 2/           # Two-char names
├── 3/s/serde    # Three-char names
└── se/rd/serde  # Four+ char names
```

---

## 7. Extension Ecosystem

### 7.1 Popular cargo-* Tools

| Tool | Purpose |
|------|---------|
| `cargo-edit` | `cargo add/rm/upgrade` |
| `cargo-watch` | Auto-rebuild on changes |
| `cargo-expand` | Expand macros |
| `cargo-deny` | Audit dependencies |
| `cargo-audit` | Security vulnerabilities |
| `cargo-outdated` | Check for updates |
| `cargo-release` | Release workflow |
| `cargo-criterion` | Benchmarking |

### 7.2 Custom Commands

```bash
# Any binary named cargo-foo becomes
cargo foo [args]
# which runs: cargo-foo [args]
```

---

## 8. Recommendations for Aria

### 8.1 Manifest Format (aria.toml)

```toml
[package]
name = "my-project"
version = "0.1.0"
authors = ["Dev <dev@example.com>"]
license = "MIT"
aria-version = ">=1.0"  # Minimum Aria version

[dependencies]
json = "2.0"
http = { version = "1.0", features = ["server"] }

[dev-dependencies]
quickcheck = "1.0"

[features]
default = ["std"]
std = []
async = ["aria-async"]

[targets]
default = "native"
wasm = { target = "wasm32", features = ["web"] }

[profile.release]
opt-level = 3
contracts = "runtime"  # vs "compile-time" or "disabled"
```

### 8.2 Build System

```aria
# build.aria (optional build script)
fn main() -> BuildResult
  # Set compile-time values
  emit("GIT_HASH", git_hash())

  # Link C libraries
  link_library("sqlite3")

  # Generate code
  generate_ffi_bindings("lib.h")

  Ok(())
end
```

### 8.3 Workspace Support

```toml
# Root aria.toml
[workspace]
members = ["core", "cli", "stdlib/*"]

[workspace.package]
version = "1.0.0"
aria-version = ">=1.0"

[workspace.dependencies]
# Shared dependency versions
```

### 8.4 Registry Design

```aria
# aria.dev registry (proposed name)
# Similar to crates.io structure

# Publish
aria publish

# Install from registry
aria add json@2.0

# Search
aria search http
```

### 8.5 Effects in Dependencies

```toml
# Declare required effects
[package]
name = "http-client"
effects = ["IO", "Async"]  # This package requires these effects

[dependencies]
# Dependencies can't introduce effects not declared
```

---

## 9. Key Resources

1. [Cargo Book](https://doc.rust-lang.org/cargo/)
2. [Cargo Source](https://github.com/rust-lang/cargo)
3. [Cargo Internals](https://doc.rust-lang.org/nightly/nightly-rustc/cargo/)
4. [crates.io Source](https://github.com/rust-lang/crates.io)
5. [Cargo Features Deep Dive](https://doc.rust-lang.org/cargo/reference/features.html)

---

## 10. Open Questions

1. Should Aria have a centralized registry or federated model?
2. How do we handle native dependencies (like build.rs)?
3. What's the versioning scheme for Aria packages?
4. Should effects be part of the package manifest?
